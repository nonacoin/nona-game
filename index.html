<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dice Party</title>

<!-- Ú©Ù„ CSS Ø´Ù…Ø§ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± -->
<!-- (Ø¨Ø±Ø§ÛŒ Ú©ÙˆØªØ§Ù‡ Ù†Ø´Ø¯Ù† Ù¾Ø§Ø³Ø®ØŒ Ø§ÛŒÙ†Ø¬Ø§ Ø­Ø°Ù Ù†Ø´Ø¯Ù‡ØŒ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‡Ù…Ø§Ù† CSS Ø§Ø±Ø³Ø§Ù„ÛŒ Ø®ÙˆØ¯Øª Ø§Ø³Øª) -->

<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>

<body>

<script>
/* ===================== */
/* ðŸ”Œ Supabase Connection */
/* ===================== */

const SUPABASE_URL = 'https://xouwoemiyxnugontsles.supabase.co';
const SUPABASE_KEY = 'sb_publishable_MFoTbKuCDjhVCs1-xvKNag_UwhV0tF-';

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const ROOM_ID = 'TEST_ROOM_1';

/* ===================== */
/* ðŸ§  Game State (Ø§ØµÙ„ÛŒ)  */
/* ===================== */

let gameState = {
  currentPlayer: 1,
  rollCount: 0,
  maxRolls: 3,
  selectedCategory: null,
  confirmedCategories: {
    player1: Array(6).fill(null),
    player2: Array(6).fill(null)
  },
  gameFinished: false,
  specialBonuses: { player1: 0, player2: 0 }
};

let diceData = [
  { id: 0, locked: false, value: 1 },
  { id: 1, locked: false, value: 1 },
  { id: 2, locked: false, value: 1 },
  { id: 3, locked: false, value: 1 },
  { id: 4, locked: false, value: 1 }
];

let timeLeft = 30;

/* ===================== */
/* ðŸ’¾ Supabase Helpers   */
/* ===================== */

async function saveRoomState() {
  await supabase
    .from('game_rooms')
    .update({
      state: {
        gameState,
        diceData,
        timeLeft
      },
      updated_at: new Date().toISOString()
    })
    .eq('room_id', ROOM_ID);
}

async function loadRoomState() {
  const { data } = await supabase
    .from('game_rooms')
    .select('state')
    .eq('room_id', ROOM_ID)
    .single();

  if (!data || !data.state) return;

  gameState = data.state.gameState;
  diceData  = data.state.diceData;
  timeLeft  = data.state.timeLeft;
}

/* ===================== */
/* ðŸ”„ Realtime Sync      */
/* ===================== */

supabase
  .channel('room-sync')
  .on(
    'postgres_changes',
    {
      event: 'UPDATE',
      schema: 'public',
      table: 'game_rooms',
      filter: `room_id=eq.${ROOM_ID}`
    },
    payload => {
      const state = payload.new.state;
      if (!state) return;

      gameState = state.gameState;
      diceData  = state.diceData;
      timeLeft  = state.timeLeft;

      renderScoreBoard();
      renderDice();
      updateTurnDisplay();
    }
  )
  .subscribe();

/* ===================== */
/* â±ï¸ Timer (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) */
/* ===================== */

let timerInterval = null;

function startTimer() {
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    timeLeft--;
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
    }
    saveRoomState();
  }, 1000);
}

/* ===================== */
/* ðŸŽ² Dice / UI Calls    */
/* ===================== */
/* â›” ØªÙ…Ø§Ù… ÙØ§Ù†Ú©Ø´Ù†â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø´Ù…Ø§ Ø§ÛŒÙ†Ø¬Ø§
   â›” Ø¨Ø¯ÙˆÙ† Ø­ØªÛŒ ÛŒÚ© ØªØºÛŒÛŒØ±
   â›” ÙÙ‚Ø· Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ Ù‡Ø± Ø§Ú©Ø´Ù† â†’ saveRoomState()
*/

/* Ù…Ø«Ø§Ù„: */

function rollDiceExample() {
  diceData.forEach(d => {
    if (!d.locked) {
      d.value = Math.floor(Math.random() * 6) + 1;
    }
  });
  saveRoomState();
}

/* ===================== */
/* ðŸš€ Init               */
/* ===================== */

window.addEventListener('DOMContentLoaded', async () => {
  await loadRoomState();
  renderScoreBoard();
  renderDice();
  updateTurnDisplay();
  startTimer();
});
</script>

</body>
</html>
