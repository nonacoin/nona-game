<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dice Party</title>

<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

</head>
<body>

<script>
/* ===================== */
/* ðŸ”Œ Supabase Ø§ØªØµØ§Ù„     */
/* ===================== */

const SUPABASE_URL = 'https://xouwoemiyxnugontsles.supabase.co';
const SUPABASE_KEY = 'sb_publishable_MFoTbKuCDjhVCs1-xvKNag_UwhV0tF-';
const ROOM_CODE = 'ROOMTEST1';
const TABLE_NAME = 'game_rooms';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===================== */
/* ðŸ“¦ Load Room State    */
/* ===================== */

async function loadGameFromSupabase() {
    const { data, error } = await supabase
        .from(TABLE_NAME)
        .select('*')
        .eq('room_code', ROOM_CODE)
        .single();

    if (error) {
        console.error('âŒ Load error:', error);
        return;
    }

    document.querySelector('#playerBox1 .player-title').textContent = data.player_one_name;
    document.querySelector('#playerBox2 .player-title').textContent = data.player_two_name;

    gameState.currentPlayer = data.current_turn === 'player_one' ? 1 : 2;
    gameStats.player1.totalScore = data.player_one_score;
    gameStats.player2.totalScore = data.player_two_score;

    if (data.game_state) {
        const gs = JSON.parse(data.game_state);

        diceData.forEach((d, i) => {
            d.value = gs.dice[i];
            d.locked = gs.lockedDice[i];
        });

        gameState.rollCount = gs.rollCount;
        timeLeft = gs.turnTimer;
    }

    updateTurnDisplay();
    renderDice();
    updateScoreDisplays();
}

/* ===================== */
/* ðŸ’¾ Save Room State    */
/* ===================== */

async function saveGameToSupabase() {
    const payload = {
        current_turn: gameState.currentPlayer === 1 ? 'player_one' : 'player_two',
        player_one_score: gameStats.player1.totalScore,
        player_two_score: gameStats.player2.totalScore,
        room_status: gameState.gameFinished ? 'finished' : 'playing',
        game_state: JSON.stringify({
            dice: diceData.map(d => d.value),
            lockedDice: diceData.map(d => d.locked),
            rollCount: gameState.rollCount,
            turnTimer: timeLeft
        }),
        updated_at: new Date().toISOString()
    };

    await supabase
        .from(TABLE_NAME)
        .update(payload)
        .eq('room_code', ROOM_CODE);
}
</script>

<!-- ðŸ‘‡ðŸ‘‡ðŸ‘‡ -->
<!-- â›” Ù‡ÛŒÚ† Ú©Ø¯ÛŒ Ø§Ø² Ø¨Ø§Ø²ÛŒ ØªØºÛŒÛŒØ± Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯Ù‡ -->
<!-- ÙÙ‚Ø· Ø¯Ø± Ù†Ù‚Ø§Ø· Ú©Ù„ÛŒØ¯ÛŒ saveGameToSupabase ØµØ¯Ø§ Ø²Ø¯Ù‡ Ø´Ø¯Ù‡ -->
<!-- ðŸ‘‡ðŸ‘‡ðŸ‘‡ -->

<script>
/* === ÙÙ‚Ø· Ù…Ø«Ø§Ù„: Ø¨Ø¹Ø¯ Ø§Ø² Ù‡Ø± ØªØºÛŒÛŒØ± === */
const originalNextTurn = nextTurn;
nextTurn = function () {
    originalNextTurn();
    saveGameToSupabase();
};

const originalRoll = document.getElementById("roll-btn")?.onclick;
document.getElementById("roll-btn").addEventListener("click", () => {
    setTimeout(saveGameToSupabase, 100);
});

const originalConfirm = document.getElementById("play-btn")?.onclick;
document.getElementById("play-btn").addEventListener("click", () => {
    setTimeout(saveGameToSupabase, 100);
});
</script>

<script>
window.addEventListener('DOMContentLoaded', async () => {
    await loadGameFromSupabase();
    startTimer();
});
</script>

</body>
</html>
