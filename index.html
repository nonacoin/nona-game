<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Dice Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ================= SUPABASE CDN ================= -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ====== CSS Ø¨Ø§Ø²ÛŒ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ====== */
body {
  font-family: sans-serif;
  background: #111;
  color: #fff;
  text-align: center;
}
</style>
</head>

<body>

<h1>ðŸŽ² Dice Game</h1>

<div id="game">
  <h2 id="playerTurn"></h2>
  <div id="dice"></div>
  <button id="rollBtn">Ø±ÛŒØ®ØªÙ† ØªØ§Ø³</button>
  <div id="scores"></div>
  <div id="timer"></div>
</div>

<script>
/* =================================================
   =============== GAME CODE (ORIGINAL) =============
   Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø¯Ø± Ù…Ù†Ø·Ù‚ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯Ù‡
   ================================================= */

let player1Name = "Player 1";
let player2Name = "Player 2";

let player1Score = 0;
let player2Score = 0;

let diceValues = [1,1,1,1,1];
let lockedDice = [false,false,false,false,false];
let rollCount = 0;
let maxRolls = 3;

let currentTurn = "player_one";
let timeLeft = 30;
let timerInterval = null;

let gamePhase = "rolling";
let isGameActive = true;
let isRolling = false;

function renderUI() {
  document.getElementById("playerTurn").innerText =
    currentTurn === "player_one" ? player1Name : player2Name;

  document.getElementById("scores").innerText =
    `${player1Name}: ${player1Score} | ${player2Name}: ${player2Score}`;

  document.getElementById("dice").innerText =
    diceValues.join(" - ");

  document.getElementById("timer").innerText =
    `â± ${timeLeft}`;
}

function rollDice() {
  if (rollCount >= maxRolls) return;

  diceValues = diceValues.map((v, i) =>
    lockedDice[i] ? v : Math.floor(Math.random() * 6) + 1
  );

  rollCount++;
  renderUI();
  saveRoomState();
}

document.getElementById("rollBtn").addEventListener("click", rollDice);

renderUI();
</script>

<script>
/* =================================================
   =============== SUPABASE LAYER ===================
   ÙÙ‚Ø· Ø§Ø±ØªØ¨Ø§Ø· â€“ Ø¨Ø¯ÙˆÙ† Ù…Ù†Ø·Ù‚ Ø¨Ø§Ø²ÛŒ
   ================================================= */

// ðŸ”‘ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
const SUPABASE_URL = "https://xouwoemiyxnugontsles.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_MFoTbKuCDjhVCs1-xvKNag_UwhV0tF-";
const TABLE_NAME = "game_rooms_state_v0";
const ROOM_CODE = "ROOMTEST1";

// ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø±
const sb = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

// ===== LOAD ROOM =====
async function loadRoomState() {
  const { data, error } = await sb
    .from(TABLE_NAME)
    .select("*")
    .eq("room_code", ROOM_CODE)
    .single();

  if (error || !data) {
    alert("âŒ Ø±ÙˆÙ… Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª");
    return;
  }

  player1Name = data.player_one_name;
  player2Name = data.player_two_name;

  player1Score = data.player_one_score;
  player2Score = data.player_two_score;

  currentTurn = data.current_turn;

  if (data.game_state) {
    diceValues = data.game_state.diceValues ?? diceValues;
    lockedDice = data.game_state.lockedDice ?? lockedDice;
    rollCount = data.game_state.rollCount ?? rollCount;
    timeLeft = data.game_state.turnTimer ?? timeLeft;
    gamePhase = data.game_state.gamePhase ?? gamePhase;
  }

  renderUI();
}

// ===== SAVE STATE =====
async function saveRoomState() {
  const gameState = {
    diceValues,
    lockedDice,
    rollCount,
    turnTimer: timeLeft,
    gamePhase
  };

  await sb
    .from(TABLE_NAME)
    .update({
      player_one_score: player1Score,
      player_two_score: player2Score,
      current_turn: currentTurn,
      game_state: gameState,
      updated_at: new Date().toISOString()
    })
    .eq("room_code", ROOM_CODE);
}

// ===== AUTO LOAD =====
window.addEventListener("load", () => {
  loadRoomState();
});
</script>

</body>
</html>
